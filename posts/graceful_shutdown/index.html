<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>:root{--accent-color:#FF4D4D}</style>
<title>Shut Down a Go HTTP Server Gracefully</title>
<meta name=description content="Gracefully shutting down a web server in Go">
<meta name=keywords content="Go,HTTP">
<meta property="og:url" content="https://followtheprocess.github.io/posts/graceful_shutdown/">
<meta property="og:type" content="website">
<meta property="og:title" content="Shut Down a Go HTTP Server Gracefully">
<meta property="og:description" content="Gracefully shutting down a web server in Go">
<meta property="og:image" content="/images/profile.jpg">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Shut Down a Go HTTP Server Gracefully">
<meta name=twitter:description content="Gracefully shutting down a web server in Go">
<meta property="twitter:domain" content="https://followtheprocess.github.io/posts/graceful_shutdown/">
<meta property="twitter:url" content="https://followtheprocess.github.io/posts/graceful_shutdown/">
<meta name=twitter:image content="/images/profile.jpg">
<link rel=canonical href=https://followtheprocess.github.io/posts/graceful_shutdown/>
<link rel=stylesheet type=text/css href=/css/normalize.min.css media=print onload="this.media='all'">
<link rel=stylesheet type=text/css href=/css/main.css>
<link disabled id=dark-theme rel=stylesheet href=/css/dark.css>
<script src=/js/svg-injector.min.js></script>
<script src=/js/feather-icons.min.js></script>
<script src=/js/main.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css integrity=sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js integrity=sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script>
</head>
<body>
<script type=text/javascript>setThemeByUserPref()</script><header class=header>
<nav class=header-nav>
<div class=avatar>
<a href=https://followtheprocess.github.io>
<img src=/images/profile.jpg alt=avatar>
</a>
</div>
<div class=nav-title>
<a class=nav-brand href=https://followtheprocess.github.io>@FollowTheProcess</a>
</div>
<div class=nav-links>
<div class=nav-link>
<a href=/> Home </a>
</div>
<div class=nav-link>
<a href=/posts/> Posts </a>
</div>
<div class=nav-link>
<a href=/projects/> Projects </a>
</div>
<div class=nav-link>
<a href=https://registry.jsonresume.org/FollowTheProcess> CV </a>
</div>
<div class=nav-link>
<a href=https://github.com/FollowTheProcess/><span data-feather=github></span> </a>
</div>
<span class=nav-icons-divider></span>
<div class="nav-link dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</div>
<div class=nav-link id=hamburger-menu-toggle>
<a>
<span data-feather=menu></span>
</a>
</div>
<ul class="nav-hamburger-list visibility-hidden">
<li class=nav-item>
<a href=/> Home </a>
</li>
<li class=nav-item>
<a href=/posts/> Posts </a>
</li>
<li class=nav-item>
<a href=/projects/> Projects </a>
</li>
<li class=nav-item>
<a href=https://registry.jsonresume.org/FollowTheProcess> CV </a>
</li>
<li class=nav-item>
<a href=https://github.com/FollowTheProcess/><span data-feather=github></span> </a>
</li>
<li class="nav-item dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</li>
</ul>
</div>
</nav>
</header>
<main id=content>
<div class="post container">
<div class=post-header-section>
<h1>Shut Down a Go HTTP Server Gracefully</h1>
<small role=doc-subtitle>Gracefully shutting down a web server in Go</small>
<p class=post-date>
October 25, 2021
</p>
<ul class=post-tags>
<li class=post-tag><a href=/tags/go>Go</a></li>
<li class=post-tag><a href=/tags/http>HTTP</a></li>
</ul>
</div>
<div class=post-content>
<p>
<p>When developing HTTP services in Go, you will start and stop your server hundreds of times, think of the whole <code>go run main.go</code> <code>ctrl + c</code> loop!</p>
<p>When you hit <code>ctrl + c</code>, (on UNIX systems) your program is passed the <code>SIGINT</code> Unix signal. The go runtime handles this and will stop your program relatively safely, but it&rsquo;s not <strong>great</strong> practice!</p>
<p>What if you have database connection pools open or forgot to close a file etc.?</p>
<p>This is where graceful shutdown comes in ðŸŽ‰</p>
<p>This is going to be a super short post just showing a good example of imnplementing graceful shutdown of a Go HTTP server.</p>
<h2 id=the-bad-way>The Bad Way</h2>
<p>A simple web server that connects to a SQL database without graceful shutdown might look something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;context&#34;</span>
    <span style=color:#e6db74>&#34;database/sql&#34;</span>
    <span style=color:#e6db74>&#34;flag&#34;</span>
    <span style=color:#e6db74>&#34;net/http&#34;</span>
    <span style=color:#e6db74>&#34;os&#34;</span>
    <span style=color:#e6db74>&#34;time&#34;</span>

    <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/go-sql-driver/mysql&#34;</span>
    <span style=color:#e6db74>&#34;github.com/sirupsen/logrus&#34;</span>
)

<span style=color:#66d9ef>const</span> (
    <span style=color:#a6e22e>defaultPort</span> = <span style=color:#e6db74>&#34;:8000&#34;</span>
    <span style=color:#a6e22e>defaultDSN</span>  = <span style=color:#e6db74>&#34;&#34;</span>
)

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>application</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>logger</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>logrus</span>.<span style=color:#a6e22e>Logger</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#75715e>// Accept command line flags for configuration and secrets
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;port&#34;</span>, <span style=color:#a6e22e>defaultPort</span>, <span style=color:#e6db74>&#34;HTTP network address&#34;</span>)
    <span style=color:#a6e22e>dsn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;dsn&#34;</span>, <span style=color:#a6e22e>defaultDSN</span>, <span style=color:#e6db74>&#34;DB Connection string&#34;</span>)
    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()

    <span style=color:#75715e>// Set up logger
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>log</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logrus</span>.<span style=color:#a6e22e>New</span>()
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Out</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>dsn</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;dsn must not be empty&#34;</span>)
    }

    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Establishing db connection&#34;</span>)
    <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>openDB</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>dsn</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;Error connecting to DB&#34;</span>)
    }
    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Closing DB connection&#34;</span>)
        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Close</span>()
    }()


    <span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>application</span>{
        <span style=color:#a6e22e>logger</span>:        <span style=color:#a6e22e>log</span>,
    }

    <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
        <span style=color:#a6e22e>Addr</span>:         <span style=color:#f92672>*</span><span style=color:#a6e22e>port</span>,
        <span style=color:#a6e22e>Handler</span>:      <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>routes</span>(),
        <span style=color:#a6e22e>ReadTimeout</span>:  <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,  <span style=color:#75715e>// max time to read request from the client
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>WriteTimeout</span>: <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#75715e>// max time to write response to the client
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>IdleTimeout</span>:  <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#75715e>// max time for connections using TCP Keep-Alive
</span><span style=color:#75715e></span>    }


    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithField</span>(<span style=color:#e6db74>&#34;port&#34;</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>port</span>).<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Starting server on port&#34;</span>)

    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>ListenAndServe</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Errorln</span>(<span style=color:#e6db74>&#34;Error starting server&#34;</span>)
    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>openDB</span>(<span style=color:#a6e22e>dsn</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#66d9ef>error</span>) {
    <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#a6e22e>dsn</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
    }
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Ping</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
    }
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>, <span style=color:#66d9ef>nil</span>
}

</code></pre></div><p>Notice how we just start the server and log the error here:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>ListenAndServe</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Errorln</span>(<span style=color:#e6db74>&#34;Error starting server&#34;</span>)
    }
</code></pre></div><p>Notice also how we close our database connection in a <code>defer</code> function:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>openDB</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>dsn</span>)
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;Error connecting to DB&#34;</span>)
    }
    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Closing DB connection&#34;</span>)
        <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Close</span>()
    }()
</code></pre></div><p>In go, when your program is interrupted with <code>SIGINT</code> deferred functions aren&rsquo;t run, so we&rsquo;re <strong>relying</strong> on the garbage collector to close our database connection. The Go garbage collector is a work of art and is very good, but <strong>relying</strong> on it when we could handle this better is just bad practice!</p>
<h2 id=a-better-way>A Better Way</h2>
<p>Let&rsquo;s handle the <code>SIGINT</code> and gracefully close down the server!</p>
<p>All we need to do is add the following block to our <code>main</code> function:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>    <span style=color:#75715e>// start the server in a goroutine so it runs off doing it&#39;s own thing
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithField</span>(<span style=color:#e6db74>&#34;port&#34;</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>port</span>).<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Starting server on port&#34;</span>)

        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>ListenAndServe</span>()
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ErrServerClosed</span> {
            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Errorln</span>(<span style=color:#e6db74>&#34;Error starting server&#34;</span>)
    }
    }()

    <span style=color:#75715e>// trap sigterm or interupt and gracefully shutdown the server
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>1</span>)
    <span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>)
    <span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Kill</span>)

    <span style=color:#75715e>// Block the rest of the code until a signal is received.
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>sig</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithField</span>(<span style=color:#e6db74>&#34;sig&#34;</span>, <span style=color:#a6e22e>sig</span>).<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Got signal&#34;</span>)
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Shutting everything down gracefully&#34;</span>)

    <span style=color:#75715e>// gracefully shutdown the server, waiting max 30 seconds for current operations to complete
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithError</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Fatalln</span>(<span style=color:#e6db74>&#34;Graceful shutdown failed&#34;</span>)
    }
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infoln</span>(<span style=color:#e6db74>&#34;Server shutdown successfully&#34;</span>)
</code></pre></div><p>So here we:</p>
<ul>
<li>Replace the call to <code>ListenAndServe</code> with one running inside an anonymous goroutine so it goes off and runs without blocking our <code>main</code></li>
<li>Make a channel on which to pass <code>SIGINT</code> and <code>SIGTERM</code></li>
<li>Register the signals using <code>signal.Notify</code></li>
<li>Then we try and pull the signal off the channel. Receiving from a channel in go is a blocking operation, meaning the code will not progress past this point unless something (in this case either <code>SIGINT</code> or <code>SIGTERM</code>) is sent on the channel. Remember, the whole time our <code>main</code> is blocked here, our server is off in it&rsquo;s own goroutine happily serving HTTP!</li>
<li>If we do get a signal, <code>main</code> unblocks and we then use <code>context</code> to gracefully shutdown the server.</li>
<li>Now because we&rsquo;ve &ldquo;trapped&rdquo; the signal sent by <code>ctrl + c</code>, our main will exit normally, meaning all the <code>defer</code> functions will run, and our DB connection pool will be cleaned up nicely!</li>
</ul>
</p>
</div>
</div>
</main><footer class=footer>
<span>&copy; 2021 Tom Fleet</span>
<span>
Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a>
</span>
</footer>
</body>
</html>