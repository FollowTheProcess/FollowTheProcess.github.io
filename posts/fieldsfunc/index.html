<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>:root{--accent-color:#FF4D4D}</style>
<title>Using FieldsFunc in Go</title>
<meta name=description content="Example of how strings.FieldsFunc is useful!">
<meta name=keywords content="go,tips">
<meta property="og:url" content="https://followtheprocess.github.io/posts/fieldsfunc/">
<meta property="og:type" content="website">
<meta property="og:title" content="Using FieldsFunc in Go">
<meta property="og:description" content="Example of how strings.FieldsFunc is useful!">
<meta property="og:image" content="/images/profile.jpg">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Using FieldsFunc in Go">
<meta name=twitter:description content="Example of how strings.FieldsFunc is useful!">
<meta property="twitter:domain" content="https://followtheprocess.github.io/posts/fieldsfunc/">
<meta property="twitter:url" content="https://followtheprocess.github.io/posts/fieldsfunc/">
<meta name=twitter:image content="/images/profile.jpg">
<link rel=canonical href=https://followtheprocess.github.io/posts/fieldsfunc/>
<link rel=stylesheet type=text/css href=/css/normalize.min.css media=print onload="this.media='all'">
<link rel=stylesheet type=text/css href=/css/main.css>
<link disabled id=dark-theme rel=stylesheet href=/css/dark.css>
<script src=/js/svg-injector.min.js></script>
<script src=/js/feather-icons.min.js></script>
<script src=/js/main.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css integrity=sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js integrity=sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script>
</head>
<body>
<script type=text/javascript>setThemeByUserPref()</script><header class=header>
<nav class=header-nav>
<div class=avatar>
<a href=https://followtheprocess.github.io>
<img src=/images/profile.jpg alt=avatar>
</a>
</div>
<div class=nav-title>
<a class=nav-brand href=https://followtheprocess.github.io>@FollowTheProcess</a>
</div>
<div class=nav-links>
<div class=nav-link>
<a href=/> Home </a>
</div>
<div class=nav-link>
<a href=/posts/> Posts </a>
</div>
<div class=nav-link>
<a href=/projects/> Projects </a>
</div>
<div class=nav-link>
<a href=https://followtheprocess.github.io/cv/> CV </a>
</div>
<div class=nav-link>
<a href=https://github.com/FollowTheProcess/><span data-feather=github></span> </a>
</div>
<div class=nav-link>
<a href=https://twitter.com/FollowTheProc><span data-feather=twitter></span> </a>
</div>
<span class=nav-icons-divider></span>
<div class="nav-link dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</div>
<div class=nav-link id=hamburger-menu-toggle>
<a>
<span data-feather=menu></span>
</a>
</div>
<ul class="nav-hamburger-list visibility-hidden">
<li class=nav-item>
<a href=/> Home </a>
</li>
<li class=nav-item>
<a href=/posts/> Posts </a>
</li>
<li class=nav-item>
<a href=/projects/> Projects </a>
</li>
<li class=nav-item>
<a href=https://followtheprocess.github.io/cv/> CV </a>
</li>
<li class=nav-item>
<a href=https://github.com/FollowTheProcess/><span data-feather=github></span> </a>
</li>
<li class=nav-item>
<a href=https://twitter.com/FollowTheProc><span data-feather=twitter></span> </a>
</li>
<li class="nav-item dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</li>
</ul>
</div>
</nav>
</header>
<main id=content>
<div class="post container">
<div class=post-header-section>
<h1>Using FieldsFunc in Go</h1>
<small role=doc-subtitle>Example of how strings.FieldsFunc is useful!</small>
<p class=post-date>
October 22, 2021
</p>
<ul class=post-tags>
<li class=post-tag><a href=/tags/go>go</a></li>
<li class=post-tag><a href=/tags/tips>tips</a></li>
</ul>
</div>
<div class=post-content>
<p>
<p>I&rsquo;ve been playing with Go a lot recently, and one thing it lends itself <strong>really</strong> well to is CLIs (Command Line Interfaces):</p>
<ul>
<li>Runs very fast, feels snappy to use</li>
<li>Standalone, statically linked binary - easy to distribute</li>
<li>Easy cross-compilation for multiple platforms, OS&rsquo;s and processor architectures</li>
<li>Excellent libraries for creating CLIs e.g. <a href=https://github.com/spf13/cobra>cobra</a></li>
</ul>
<p>The excellent <a href=https://github.com/cli/cli>GitHub CLI</a> is written in Go üëèüèª</p>
<p>So needless to say, I&rsquo;ve been writing more than a few CLIs: <a href=https://github.com/FollowTheProcess/gotoil>gotoil</a>, <a href=https://github.com/FollowTheProcess/tag>tag</a>, <a href=https://github.com/FollowTheProcess/goignore>goignore</a> etc&mldr;</p>
<p>As part of this I&rsquo;ve found that a very common workflow in many CLI functions is:</p>
<ol>
<li>Shell out to an external program (e.g. git)</li>
<li>Capture the output from it (typically a newline separated list)</li>
<li>Use that output in your CLI</li>
</ol>
<p>An example for this might be in <a href=https://github.com/FollowTheProcess/tag>tag</a> where I parse the output from commands like <code>git tag --sort='-v:refname'</code> to get
lists of semver git tags etc.</p>
<p>You could also imagine potentially parsing the output of <code>ls</code> or <code>ps</code> to get directory or running process info for example.</p>
<p>It&rsquo;s here where I&rsquo;ve found <code>strings.FieldsFunc</code> incredibly useful!</p>
<h2 id=the-problem>The Problem</h2>
<p>Basically, we want to capture output from an external tool that looks something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>item1
item2
item3
item4
</code></pre></div><p>I.e. a newline &lsquo;/n&rsquo; separated list of stuff.</p>
<h2 id=initial-solution>Initial Solution</h2>
<p>A first step in Go might be something like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// GetData invokes &#34;external command&#34; and returns it&#39;s output as
</span><span style=color:#75715e>// a string slice
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetData</span>() ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;some&#34;</span>, <span style=color:#e6db74>&#34;external&#34;</span>, <span style=color:#e6db74>&#34;command&#34;</span>)

    <span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>CombinedOutput</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// Handle the error like good little programmers
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;command error: %s: %w&#34;</span>, string(<span style=color:#a6e22e>out</span>), <span style=color:#a6e22e>err</span>)
    }

    <span style=color:#a6e22e>elements</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(string(<span style=color:#a6e22e>out</span>), <span style=color:#e6db74>&#34;\n&#34;</span>)

    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elements</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>This is fine, it gets us what we want, something like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>elements</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetData</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#e6db74>&#34;error getting command data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
        <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
    }

    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v\n&#34;</span>, <span style=color:#a6e22e>elements</span>)
}
<span style=color:#75715e>// Output: [item1 item2 item3 item4]
</span></code></pre></div><p>This seems fine right? We&rsquo;ve split up out output by newlines and we have a string slice of the elements we wanted. Job done üéâ</p>
<h2 id=uh-oh>Uh oh</h2>
<p>Sadly not quite&mldr; What if our output has a trailing newline:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>elements</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetData</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#e6db74>&#34;error getting command data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
        <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
    }

    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v\n&#34;</span>, <span style=color:#a6e22e>elements</span>)
}
<span style=color:#75715e>// Output: [item1 item2 item3 item4 ]
</span></code></pre></div><p>Did you see that? There&rsquo;s a tiny space at the end of the slice that&rsquo;s very difficult to spot, especially in tests!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Before: [item1 item2 item3 item4]
</span><span style=color:#75715e>// After: [item1 item2 item3 item4 ]
</span></code></pre></div><p>To get a clearer picture we can use the <code>%#v</code> <code>Printf</code> verb which gives you a more &ldquo;goish&rdquo; representation:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>elements</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetData</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#e6db74>&#34;error getting command data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
        <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
    }

    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%#v\n&#34;</span>, <span style=color:#a6e22e>elements</span>)
}
<span style=color:#75715e>// Output: []string{&#34;item1&#34;, &#34;item2&#34;, &#34;item3&#34;, &#34;item4&#34;, &#34;&#34;}
</span></code></pre></div><p>Look! A pesky empty string at the end of the slice caused by the trailing newline.</p>
<p>Now we could write some quick code to check for this trailing empty string in the slice and remove it but there is a better way!</p>
<h2 id=fieldsfunc>FieldsFunc</h2>
<p>Enter <code>strings.FieldsFunc</code>, see the <a href=https://pkg.go.dev/strings#FieldsFunc>docs</a></p>
<p>We can get exactly what we want by changing our <code>GetData</code> function like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// GetData invokes &#34;external command&#34; and returns it&#39;s output as
</span><span style=color:#75715e>// a string slice
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetData</span>() ([]<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
    <span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;some&#34;</span>, <span style=color:#e6db74>&#34;external&#34;</span>, <span style=color:#e6db74>&#34;command&#34;</span>)

    <span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>CombinedOutput</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#75715e>// Handle the error like good little programmers
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;command error: %s: %w&#34;</span>, string(<span style=color:#a6e22e>out</span>), <span style=color:#a6e22e>err</span>)
    }

    <span style=color:#75715e>// Anonymous function that returns true on newlines
</span><span style=color:#75715e></span>    <span style=color:#75715e>// this is what does the splitting for us
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#66d9ef>rune</span>) <span style=color:#66d9ef>bool</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\n&#39;</span>
    }

    <span style=color:#a6e22e>elements</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>FieldsFunc</span>(string(<span style=color:#a6e22e>out</span>), <span style=color:#a6e22e>f</span>)

    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elements</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>Now, like magic our slice is the same regardless of whether or not there is a trailing newline in the output!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>elements</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetData</span>()
    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#e6db74>&#34;error getting command data: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
        <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
    }

    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%#v\n&#34;</span>, <span style=color:#a6e22e>elements</span>)
}
<span style=color:#75715e>// Output: []string{&#34;item1&#34;, &#34;item2&#34;, &#34;item3&#34;, &#34;item4&#34;}
</span><span style=color:#75715e>// We win!
</span></code></pre></div>
</p>
</div>
</div>
</main><footer class=footer>
<span>&copy; 2022 Tom Fleet</span>
<span>
Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a>
</span>
</footer>
</body>
</html>