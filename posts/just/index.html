<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Just > Make</title>
<meta name=description content="Hate writing makefiles? Use just ðŸŽ‰"><meta name=keywords content='tips,command line,utilities'><meta property="og:url" content="https://followtheprocess.github.io/posts/just/"><meta property="og:type" content="website"><meta property="og:title" content="Just > Make"><meta property="og:description" content="Hate writing makefiles? Use just ðŸŽ‰"><meta property="og:image" content="https://followtheprocess.github.io/images/profile.jpg"><meta property="og:image:secure_url" content="https://followtheprocess.github.io/images/profile.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Just > Make"><meta name=twitter:description content="Hate writing makefiles? Use just ðŸŽ‰"><meta property="twitter:domain" content="https://followtheprocess.github.io/posts/just/"><meta property="twitter:url" content="https://followtheprocess.github.io/posts/just/"><meta name=twitter:image content="https://followtheprocess.github.io/images/profile.jpg"><link rel=canonical href=https://followtheprocess.github.io/posts/just/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.9a920d7dabdbad8363b6a0a94e29a9dfebdb7ee64cfcb193a0145e512ef2bdab.js integrity="sha256-mpINfavbrYNjtqCpTimp3+vbfuZM/LGToBReUS7yvas="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css integrity=sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js integrity=sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://followtheprocess.github.io/><img src=/images/profile.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://followtheprocess.github.io/>@FollowTheProcess</a></div><div class=nav-links><div class=nav-link><a href=https://followtheprocess.github.io/>Home</a></div><div class=nav-link><a href=https://followtheprocess.github.io/posts/>Posts</a></div><div class=nav-link><a href=https://followtheprocess.github.io/projects/>Projects</a></div><div class=nav-link><a href=https://followtheprocess.github.io/cv/>CV</a></div><div class=nav-link><a href=https://github.com/FollowTheProcess/><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target"></span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://followtheprocess.github.io/>Home</a></li><li class=nav-item><a href=https://followtheprocess.github.io/posts/>Posts</a></li><li class=nav-item><a href=https://followtheprocess.github.io/projects/>Projects</a></li><li class=nav-item><a href=https://followtheprocess.github.io/cv/>CV</a></li><li class=nav-item><a href=https://github.com/FollowTheProcess/><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Just > Make</h1><small role=doc-subtitle>Hate writing makefiles? Use just ðŸŽ‰</small><p class=post-date>October 24, 2021</p><ul class=post-tags><li class=post-tag><a href=https://followtheprocess.github.io/tags/tips>tips</a></li><li class=post-tag><a href=https://followtheprocess.github.io/tags/command-line>command line</a></li><li class=post-tag><a href=https://followtheprocess.github.io/tags/utilities>utilities</a></li></ul></div><div class=post-content><p>Makefiles (<a href=https://www.gnu.org/software/make/>GNU Make</a>) are ubiquitous in software development and they are a fantastically useful tool! But for all but the simplest tasks, the syntax can get very unreadable and messy.</p><p>Some programs like complex C or C++ projects will use Makefiles as the full build system it was designed to be, however most people tend to use Makefiles as simple task runners.</p><p>Consider the following example for a simple Go project:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>.PHONY</span><span style=color:#ff7b72;font-weight:700>:</span> build test lint
</span></span><span style=display:flex><span><span style=color:#79c0ff>.DEFAULT_GOAL</span> <span style=color:#ff7b72;font-weight:700>:=</span> help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>help</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    @echo <span style=color:#a5d6ff>&#34;Available Tasks\n&#34;</span>
</span></span><span style=display:flex><span>    @echo <span style=color:#a5d6ff>&#34;build :  Compile the project&#34;</span>
</span></span><span style=display:flex><span>    @echo <span style=color:#a5d6ff>&#34;test  :  Run unit tests&#34;</span>
</span></span><span style=display:flex><span>    @echo <span style=color:#a5d6ff>&#34;lint  :  Run linting&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>build</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go build .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>test</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go test -race ./...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>lint</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    golangci-lint run
</span></span></code></pre></div><p>Here we tell make not to treat our tasks as directories (<code>.PHONY</code>), give it the default target of <code>help</code> so that when just running <code>make</code> by itself we see the help, and then define our tasks.</p><p>For these types of simple tasks where you don&rsquo;t need the incremental build nature of make, I recommend using <a href=https://github.com/casey/just>just</a> instead!</p><h2 id=just>Just</h2><p>Just is like make but more focused on being a command runner rather than a fully fledged build system. It let&rsquo;s you do a few cool things that are either impossible or tricky to do in make!</p><p>Just is available in all sorts of ways, if you&rsquo;re on macOS you can get it with <a href=https://brew.sh>homebrew</a>:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install just
</span></span></code></pre></div><p>Just is configured using a <code>justfile</code> (like make&rsquo;s <code>makefile</code>). The equivalent <code>justfile</code> to our makefile above would look like this:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>_default</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    @just --list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Compile the program
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>build</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go build .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Run unit tests
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>test</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go test -race ./...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Run linting
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>lint</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    golangci-lint run
</span></span></code></pre></div><p>Now when you run <code>just</code> you will see something like this:</p><p><img src=/images/posts/just/help.png alt=help></p><p>And look how simple our file is! Even if you have no idea about just or make, you could definitely work out what it&rsquo;s doing. There&rsquo;s a couple of cool features going on here:</p><ul><li>Setting a private default recipe <code>_default</code> to show to the list of all recipes <code>@just --list</code></li><li>The comments are used as the help text automatically</li></ul><p>So no need for <code>.PHONY</code> or our own custom <code>help</code> target (which could easily fall out of date with the actual recipes)</p><p>If you&rsquo;re just after a simple replacement for make as a task runner, you could probably stop here and go read the <a href=https://github.com/casey/just/blob/master/README.adoc>docs</a> for just to learn more. The rest of this post will be just a few examples of how I&rsquo;ve used just to achieve some cool things.</p><h2 id=global-variables>Global Variables</h2><p>You can declare variables with make of course, but I always end up googling the syntax and there&rsquo;s certain things it can&rsquo;t do. Just&rsquo;s variable declaration syntax is super easy:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#79c0ff>name</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;alice&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>hello</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    @echo <span style=color:#a5d6ff>&#34;Hello {{ name }}&#34;</span>
</span></span></code></pre></div><p>Now when you run <code>just hello</code>:</p><p><img src=/images/posts/just/hello.png alt=hello></p><p>I often use this to set compilation flags, for example:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#79c0ff>project_name</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;tag&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>project_path</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;github.com/FollowTheProcess/tag&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>project_entry_point</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;./cmd/tag&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>project_binaries</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;./bin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>ver_ldflag</span> <span style=color:#ff7b72;font-weight:700>:=</span> project_path + <span style=color:#a5d6ff>&#34;/cli/cmd.version&#34;</span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>sha_ldflag</span> <span style=color:#ff7b72;font-weight:700>:=</span> project_path + <span style=color:#a5d6ff>&#34;/cli/cmd.commit&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>commit_sha</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>`</span>git rev-parse HEAD<span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Compile the project binary
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>build</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go build -ldflags<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;-s -w -X {{ ver_ldflag }}=dev -X {{ sha_ldflag }}={{ commit_sha }}&#34;</span> -o <span style=color:#ff7b72;font-weight:700>{{</span> project_binaries <span style=color:#ff7b72;font-weight:700>}}</span>/<span style=color:#ff7b72;font-weight:700>{{</span> project_name <span style=color:#ff7b72;font-weight:700>}}</span> <span style=color:#ff7b72;font-weight:700>{{</span> project_entry_point <span style=color:#ff7b72;font-weight:700>}}</span>
</span></span></code></pre></div><p>So now when I build (in this case <a href=https://github.com/FollowTheProcess/tag>tag</a>), the version and the commit hash are compiled into the binary itself. So when you run <code>tag version</code> these are displayed to the user.</p><p>Now, did you spot this: <code>git rev-parse HEAD</code> ðŸ¤”&mldr;</p><h2 id=getting-info-from-external-commands>Getting Info from External Commands</h2><p>In just, when you declare a variable with backticks the expression inside the backticks is run in a shell and the output of that expression is used as the variable.</p><p>So in this expression:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#79c0ff>commit_sha</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>`</span>git rev-parse HEAD<span style=color:#a5d6ff>`</span>
</span></span></code></pre></div><p><code>git rev-parse HEAD</code> is run in a shell, and the output (e.g. <code>c1bbddbd6d9486e1a5e32e0b8d8a0bb9094eb269</code>) is used as the variable.</p><p>I find this spectacularly useful! It means you can grep and glob to your hearts content to populate variables in your <code>justfile</code></p><h2 id=keep-your-credentials-hidden-in-env-files>Keep your Credentials Hidden in .env files</h2><p>If you&rsquo;re developing web stuff like REST APIs, you&rsquo;ll more often than not have to connect to a database. This involves managing credentials like DB users and passwords etc and this can be tricky!</p><p>A common solution is to use environment variables (e.g. <code>export DB_PASSWORD "superpassword"</code>) then grabbing this in your code.</p><p>I prefer to use command line flags for this. Let&rsquo;s look at a very simple Go web server that connects to a database:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// main.go
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;os/signal&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _ <span style=color:#a5d6ff>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> (
</span></span><span style=display:flex><span>    defaultPort = <span style=color:#a5d6ff>&#34;:8000&#34;</span>   <span style=color:#8b949e;font-style:italic>// Default port to serve on
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    defaultDSN  = <span style=color:#a5d6ff>&#34;&#34;</span>        <span style=color:#8b949e;font-style:italic>// Default DB connection string
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> application <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    logger        <span style=color:#ff7b72;font-weight:700>*</span>logrus.Logger
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Accept command line flags for configuration and secrets
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    port <span style=color:#ff7b72;font-weight:700>:=</span> flag.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;port&#34;</span>, defaultPort, <span style=color:#a5d6ff>&#34;HTTP network address&#34;</span>)
</span></span><span style=display:flex><span>    dsn <span style=color:#ff7b72;font-weight:700>:=</span> flag.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;dsn&#34;</span>, defaultDSN, <span style=color:#a5d6ff>&#34;MySQL data source name&#34;</span>)
</span></span><span style=display:flex><span>    flag.<span style=color:#d2a8ff;font-weight:700>Parse</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Set up logger
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    log <span style=color:#ff7b72;font-weight:700>:=</span> logrus.<span style=color:#d2a8ff;font-weight:700>New</span>()
</span></span><span style=display:flex><span>    log.Out = os.Stdout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>*</span>dsn <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        log.<span style=color:#d2a8ff;font-weight:700>Fatalln</span>(<span style=color:#a5d6ff>&#34;dsn must not be empty&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log.<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Establishing db connection&#34;</span>)
</span></span><span style=display:flex><span>    db, err <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#d2a8ff;font-weight:700>openDB</span>(<span style=color:#ff7b72;font-weight:700>*</span>dsn)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        log.<span style=color:#d2a8ff;font-weight:700>WithError</span>(err).<span style=color:#d2a8ff;font-weight:700>Fatalln</span>(<span style=color:#a5d6ff>&#34;Error connecting to DB&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>        log.<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Closing DB connection&#34;</span>)
</span></span><span style=display:flex><span>        db.<span style=color:#d2a8ff;font-weight:700>Close</span>()
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>application{
</span></span><span style=display:flex><span>        logger:        log,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    srv <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>http.Server{
</span></span><span style=display:flex><span>        Addr:         <span style=color:#ff7b72;font-weight:700>*</span>port,
</span></span><span style=display:flex><span>        Handler:      app.<span style=color:#d2a8ff;font-weight:700>routes</span>(),
</span></span><span style=display:flex><span>        ReadTimeout:  <span style=color:#a5d6ff>5</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second,  <span style=color:#8b949e;font-style:italic>// max time to read request from the client
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        WriteTimeout: <span style=color:#a5d6ff>10</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second, <span style=color:#8b949e;font-style:italic>// max time to write response to the client
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        IdleTimeout:  <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second, <span style=color:#8b949e;font-style:italic>// max time for connections using TCP Keep-Alive
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// start the server in a goroutine so it runs off doing it&#39;s own thing
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>go</span> <span style=color:#ff7b72>func</span>() {
</span></span><span style=display:flex><span>        log.<span style=color:#d2a8ff;font-weight:700>WithField</span>(<span style=color:#a5d6ff>&#34;port&#34;</span>, <span style=color:#ff7b72;font-weight:700>*</span>port).<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Starting server on port&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        err <span style=color:#ff7b72;font-weight:700>:=</span> srv.<span style=color:#d2a8ff;font-weight:700>ListenAndServe</span>()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> err <span style=color:#ff7b72;font-weight:700>!=</span> http.ErrServerClosed {
</span></span><span style=display:flex><span>            log.<span style=color:#d2a8ff;font-weight:700>WithError</span>(err).<span style=color:#d2a8ff;font-weight:700>Errorln</span>(<span style=color:#a5d6ff>&#34;Error starting server&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// trap sigterm or interrupt and gracefully shutdown the server
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    c <span style=color:#ff7b72;font-weight:700>:=</span> make(<span style=color:#ff7b72>chan</span> os.Signal, <span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>    signal.<span style=color:#d2a8ff;font-weight:700>Notify</span>(c, os.Interrupt)
</span></span><span style=display:flex><span>    signal.<span style=color:#d2a8ff;font-weight:700>Notify</span>(c, os.Kill)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Block the rest of the code until a signal is received.
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    sig <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&lt;-</span>c
</span></span><span style=display:flex><span>    log.<span style=color:#d2a8ff;font-weight:700>WithField</span>(<span style=color:#a5d6ff>&#34;sig&#34;</span>, sig).<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Got signal&#34;</span>)
</span></span><span style=display:flex><span>    log.<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Shutting everything down gracefully&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// gracefully shutdown the server, waiting max 30 seconds for current operations to complete
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    ctx, cancel <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>WithTimeout</span>(context.<span style=color:#d2a8ff;font-weight:700>Background</span>(), <span style=color:#a5d6ff>30</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> <span style=color:#d2a8ff;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> srv.<span style=color:#d2a8ff;font-weight:700>Shutdown</span>(ctx); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        log.<span style=color:#d2a8ff;font-weight:700>WithError</span>(err).<span style=color:#d2a8ff;font-weight:700>Fatalln</span>(<span style=color:#a5d6ff>&#34;Graceful shutdown failed&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    log.<span style=color:#d2a8ff;font-weight:700>Infoln</span>(<span style=color:#a5d6ff>&#34;Server shutdown successfully&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>openDB</span>(dsn <span style=color:#ff7b72>string</span>) (<span style=color:#ff7b72;font-weight:700>*</span>sql.DB, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    db, err <span style=color:#ff7b72;font-weight:700>:=</span> sql.<span style=color:#d2a8ff;font-weight:700>Open</span>(<span style=color:#a5d6ff>&#34;mysql&#34;</span>, dsn)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err = db.<span style=color:#d2a8ff;font-weight:700>Ping</span>(); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> db, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The actual Go code is somewhat unimportant, I&rsquo;ve included a complete example because too often these things are meaningless toy examples.</p><p>The key thing to note is that we&rsquo;re taking our database connection string (which contains the user and password) from a command line flag.</p><p>This is where just comes in! Rather than typing this out, we can store these things in a .env file (which should be gitignored!):</p><pre tabindex=0><code class=language-dotenv data-lang=dotenv>DB_USER=user
DB_NAME=mydatabase
DB_PASSWORD=superpassword
</code></pre><p>Just can load <code>.env</code> files and work with the things defined in them. So now all we need to do is:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#d2a8ff;font-weight:700>set dotenv-load </span><span style=color:#ff7b72;font-weight:700>:</span>= true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#79c0ff>port</span> <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>&#34;:8000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Start the development server
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#d2a8ff;font-weight:700>start</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>    go run main.go -dsn<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>$DB_USER</span><span style=color:#a5d6ff>:</span><span style=color:#79c0ff>$DB_PASSWORD</span><span style=color:#a5d6ff>@/</span><span style=color:#79c0ff>$DB_NAME</span><span style=color:#a5d6ff>&#34;</span> -port<span style=color:#ff7b72;font-weight:700>={{</span> port <span style=color:#ff7b72;font-weight:700>}}</span>
</span></span></code></pre></div><p>And this will work exactly as expected! Your variables in the <code>.env</code> file will be plugged in to the dsn and your application will run. Doing it this way means there is no danger of leaking credentials and aslong as you use just to launch your application, everything will work! &#x1f389;</p><h2 id=more>More</h2><p>Just can do <strong>loads</strong> more cool stuff than I&rsquo;ve listed here, these were just a few examples I thought were worthy of sharing. Check out the <a href=https://github.com/casey/just/blob/master/README.adoc>docs</a> and support the project. Full credit to <a href=https://github.com/casey>casey</a> for the amazing work on <a href=https://github.com/casey/just>just</a>!</p></div><div class=prev-next></div></div></main><footer class=footer><span>&copy; 2021 Tom Fleet</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>